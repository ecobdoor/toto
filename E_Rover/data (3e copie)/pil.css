const DEF_QUERY_ROVER_TO_BASIS="rQb",DEF_REPLY_BASIS_TO_ROVER="bRr",DEF_QUERY_BASIS_TO_ROVER="bQr",DEF_REPLY_ROVER_TO_BASIS="rRb",DEF_QUERY_PILOT_TO_ROVER="pQr",DEF_REPLY_ROVER_TO_PILOT="rRp",DEF_QUERY_ROVER_TO_PILOT="rQp",DEF_REPLY_PILOT_TO_ROVER="pRr",DEF_QUERY_BASIS_TO_PILOT="bQp",DEF_REPLY_PILOT_TO_BASIS="pRb",DEF_QUERY_PILOT_TO_BASIS="pQb",DEF_REPLY_BASIS_TO_PILOT="bRp",DEF_KF_DIR="D",DEF_KF_SPD="S",DEF_KF_LFT="L",DEF_KF_RGT="R",DEF_KF_FIL="F",DEF_KF_GET="@",DEF_KF_EXE="X",DEF_KF_MTS="MTS",DEF_KF_PMTS="MTS",DEF_KF_IMUT="DTK",DEF_KF_XC0="XC0",DEF_KF_YC0="YC0",DEF_KF_ZC0="ZC0",DEF_KF_ROLL="DNR",DEF_KF_PITCH="DEP",DEF_KF_YAW="DDY",DEF_KF_GRX="DGX",DEF_KF_GRY="DGY",DEF_KF_GRZ="DGZ",DEF_KF_DIST="DST",DEF_KF_LAX="DAX",DEF_KF_LAY="DAY",DEF_KF_LAZ="DAZ",DEF_KF_SPX="SPX",DEF_KF_SPY="SPY",DEF_KF_SPZ="SPZ",DEF_KF_Iax="Iax",DEF_KF_Iay="Iay",DEF_KF_Iaz="Iaz",DEF_KF_Igx="Igx",DEF_KF_Igy="Igy",DEF_KF_Igz="Igz",DEF_KF_Imx="Imx",DEF_KF_Imy="Imy",DEF_KF_Imz="Imz",DEF_OP_INFO="Inf",DEF_OP_MOT="Mot",DEF_OP_PID="Pid",DEF_OP_STOP="Stop",DEF_OP_OPEN="Open",DEF_OP_CLOSE="Close",DEF_OP_SYNC="Syn",DEF_OP_LEARN="Learn",DEF_OP_JOBGOAL="Jobgoal",DEF_OP_PILOT="Pilot",DEF_OP_TSTSQ="TstSQ",DEF_OP_SETDLVL="set_DLVL",DEF_OP_SETTOUT="setTmsOut",DEF_OP_GETTOUT="getTmsOut",DEF_OP_OK="Ok?",DEF_OP_CHK="Chk",DEF_DBGBROWSER=3,DEF_DBGLVLMAX=3,DEF_SEND_TMS=0,DEF_SEND_TMS_JOBGOAL=333,DEF_WATCH_TMS=300;var allCFG={roverURL:"192.168.4.1",roverPORT:80,basisURL:"localhost",basisPORT:1337,depthFIFO:16,BamountTMS:500};const DEF_MOTORS_NBAXIS=2;var MOTORScfg={MOD:{loop_TMS:0,Name:"MOTORS",Mid:"MOT",Qtype:"rQp"}},DRIVERcfg={MOD:{loop_TMS:100,Name:"DRIVER",Mid:"DRV",Qtype:"rQp"}},WATCHDOGcfg={MOD:{loop_TMS:1e3,Name:"WATCHDOG",Mid:"WAT",Qtype:"rQp"}},JOBGOALcfg={MOD:{loop_TMS:2e3,Name:"JOBGOAL",Mid:"JOB",Qtype:"rQp"}},TIMEMScfg={MOD:{loop_TMS:0,Name:"TIMEms",Mid:"TMS",Qtype:"rQp"}},basisCFG={loop_TMS:0,watch_TMS:300,cnx_ROVER:!0,PAT2NOD:"/media/DEV/ROB_000/node.js/node_modules/"},pilotCFG={loop_TMS:0,watch_TMS:300,cnx_ROVER:!0,cnx_BASIS:!0};function waitFor(t){console.log("waitFor ",t," ms...");setTimeout(function(){alert("Hello"),console.log("++++++++++++++++++++++++++++++")},t);return t}function _NOP_(){}function _WAITMS_(t){for(var e=_TMS_(),s=_TMS_();s-e<t;)s=_TMS_()}function int2FixString(t,e){return("000000"+t).slice(-e)}function SF_float(t,e,s){for(var n=t.toFixed(s);n.length<e;)n=" "+n;return n}function strReplace(t,e,s){var n=new RegExp(e,"gi");return t.replace(n,s)}function filesToHtmlSelect(t,e,s,n){var o=0,i="<select id='"+t+"' class='mv2_select "+(void 0===n?"":" "+n)+"'>";for(var _ in e)if("object"==typeof e[_].opt){if(_==s)var r=' selected="selected"';else r="";i+="<option value="+o+r+">"+e[_].opt.entry+"</option>",o++}return i+="</select>",console.log("filesToHtmlSelect OPTIONS.length",o),i}console.log("util.js coming..."),_TMS_=function(){return(new Date).getTime()-15377e8},isDefined=function(t){return!(void 0===t)},isObject=function(t){return"object"==typeof t},clone=function(t){try{var e=JSON.parse(JSON.stringify(t))}catch(t){alert("Vous utilisez un vieux navigateur bien pourri, qui n'est pas pris en charge par ce site")}return e},MODULES=new Array;var eltQUERY=new Array,eltREPLY=new Array;function SNS(t){return"Q"==t[1]?eltQUERY[t].SNS:"R"==t[1]?eltREPLY[t].SNS:($alert("Error CTL '"+CTL+"' unknown"),"?")}eltQUERY.pQr={SNS:"=",ACK:"rRp"},eltREPLY.rRp={SNS:"="},eltQUERY.rQp={SNS:"≈",ACK:"pRr"},eltREPLY.pRr={SNS:"≈"},eltQUERY.pQb={SNS:"-",ACK:"bRp"},eltREPLY.bRp={SNS:"-"},eltQUERY.bQp={SNS:"~",ACK:"pRb"},eltREPLY.pRb={SNS:"~"},eltQUERY.bQr={SNS:"≈",ACK:"rRb"},eltREPLY.rRb={SNS:"≈"},eltQUERY.rQb={SNS:"≈",ACK:"bRr"},eltREPLY.bRr={SNS:"≈"};var dt=0,scheduler=-1,cntQUERIES=0,skippedCnt=0;function S_tick(t){for(var e=t.toString(10);e.length<10;)e="."+e;return e}function logHeader(t,e){return"("+fifoWait.length+"/"+fifoLost.length+") "+S_tick(e.CTL.TIK)+" "+t._name+"("+t.cntWScnx+") "}function lookForTIK(t){for(var e={},s=fifoWait.length-1;s>=0;s--)fifoWait[s].TIK===t.TIK?(Object.assign(e,fifoWait[s]),fifoWait.splice(s,1)):fifoWait[s].TIK<t.TIK&&(fifoLost.push(fifoWait[s]),fifoWait.splice(s,1));return e}function SOKreply2query(t,e,s){var n=e.KMD.MID,o=(MODULES[n].reply2query(e.KMD),Object.assign({},e));o.CTL.TYP=s;var i=JSON.stringify(o);return t.sendCLI(i),i}fifoWait=new Array,fifoLost=new Array,Timer=function(){var t=this,e=-1,s=!1,n=function(){alert("_Function not initialized.")};this._Timeout,this.START_loop=function(o){t._Timeout=o,clearInterval(e),s=!0,e=setInterval(n,o)},this.START_oneShoot=function(o){t._Timeout=o,clearInterval(e),s=!1,e=setTimeout(n,o)},this.STOP=function(){s=!1,clearInterval(e)},this.CHANGE=function(o){n=o,s&&(clearInterval(e),e=setInterval(o,t._Timeout))}},ON_MESSAGE=function(t,e,s){var n,o={TYP:"?"};try{console.log(s),n=JSON.parse(s.substr(s.indexOf("{")))}catch(t){return console.error("Parsing error:",t),o}var i,_,r=n.CTL.TYP;if(o.TYP=r[1],"R"==o.TYP){void 0===eltREPLY[r]?alert(n.CTL.TYP+" Type erreur"):_=Object.assign({},eltREPLY[r]),o.RJsonchn=s,_.SNS=logHeader(t,n)+"<"+_.SNS+" REPLY "+n.KMD.MID+" [";lookForTIK(n.CTL);var l=n.KMD.MID;MODULES[l].update2reply(n.KMD);var a=cntQUERIES-n.CTL.TIK;o.InfoRchn="] delta(TIK="+a.toString()+")"}else"Q"==o.TYP?(void 0===eltQUERY[r]?alert(n.CTL.TYP+" Type erreur"):(i=Object.assign({},eltQUERY[r]),_=Object.assign({},eltREPLY[i.ACK])),o.QJsonchn=s,o.InfoQchn="]<br>",i.SNS=logHeader(t,n)+"<"+i.SNS+" query "+n.KMD.MID+" [",console.log(i.SNS+s),_.SNS=logHeader(t,n)+_.SNS+"> reply "+n.KMD.MID+" [",o.RJsonchn=SOKreply2query(t,n,i.ACK),console.log(_.SNS+o.RJsonchn),o.InfoRchn="]<br>",o.Qsignals=i):(console.log("<?"+s),$alert("CTL.TYPE error on\n"+s));return o.Rsignals=_,o},generateQUERY=function(t,e){cntQUERIES++,this.CTL={TYP:t,TIK:cntQUERIES},this.KMD={MID:e.Mid,OP:"Nop",CHN:"Pilot "+t},fifoWait.push({TYP:this.CTL.TYP,TIK:this.CTL.TIK,TMS:(new Date).getTime()})};var intervalId=null;function finish(){clearInterval(intervalId)}function test(t,e,s,n,o){e(s)?finish():(o.WAIT=(new Date).getTime()-n,o.WAIT>t&&(o.ERR=10,skippedCnt++,finish()))}function testWSBATO(t){return 0==t.bufferedAmount}function start(t,e,s,n,o){o.ERR=0,o.WAIT=0,intervalId=setInterval(test,3,e,s,n,(new Date).getTime(),o)}sendJSON=function(t,e,s){var n={};start(3,s,testWSBATO,t.WS,n),0!=n.WAIT&&alert(n.WAIT=0);var o=">>[";return 0==n.ERR?("object"==typeof e?(o=SNS(e.CTL.TYP)+">[",n.MSG=JSON.stringify(e),console.log(o,n.MSG,"]")):(n.MSG=e,console.log(o,e,"]as is...")),t.sendCLI(n.MSG)):console.log(o,n.MSG,"] !!!!!!!!!! error ",n.ERR),n},sendKMD=function(t,e,s,n){cntQUERIES++;var o={};o.TYP=t.PROTOCOL,o.TIK=cntQUERIES;var i={};i.CTL=o,i.KMD=Object.assign({MID:e},s),3===t.WS.readyState&&addMsg(0,t.WS.url+" injoignable (pas de réseau)"),addMsg(0,logHeader(t,i)+">> QUERY "+e+" [",JSON.stringify(i),"]"),sendJSON(t,i,n),fifoWait.push({TYP:o.TYP,TIK:o.TIK,TMS:(new Date).getTime()})},fifoDump=function(t,e){for(var s=t+"["+e.length+"]=|",n=e.length-1;n>=0;n--)s+=e[n].TIK+"|";return s};class Module{constructor(t){this._name=t.Name,this._Mid=t.Mid,this._protocol=t.Qtype,this._period=t.loop_TMS,this._lastTMS=(new Date).getTime(),console.log("~","\n-Creates module ",this._name,this._protocol,this._period)}QUERY(t){this._lastTMS=(new Date).getTime(),cntQUERIES++;var e,s={CTL:{},KMD:{}};return e=void 0===t?this._protocol:t,s.CTL={TYP:e,TIK:cntQUERIES},s.KMD={MID:this._Mid},s}}class mod_MOTORS extends Module{constructor(t){super(MOTORScfg.MOD),t[this._Mid]=this}QUERY(t){var e=super.QUERY(t);return Object.defineProperty(e.KMD,DEF_KF_LFT,{value:100,writable:!1,enumerable:!0}),Object.defineProperty(e.KMD,DEF_KF_RGT,{value:123,writable:!1,enumerable:!0}),fifoWait.push(e.CTL),e}}class mod_TIMEMS extends Module{constructor(t){super(TIMEMScfg.MOD),t[this._Mid]=this}QUERY(t){var e=super.QUERY(t);return Object.defineProperty(e.KMD,"T",{value:(new Date).getTime(),writable:!1,enumerable:!0}),fifoWait.push(e.CTL),e}}function strReplace(t,e,s){var n=new RegExp(e,"gi");return t.replace(n,s)}const pokeState={poked:0,fifoFull_:1},pikeState={piked:0,timeOut_:1,notFound_:2};var jctManager=function(){},FifoAck=function(t){var e=new Array(t);this._latence=0,this.clear=function(){for(var s=0;s<t;s++)e[s]={TIK:0,MSG:"",TMS:0}},this.clear(),this.waitingACK=function(){for(var s=0,n=0;n<t;n++)0!=e[n].TIK&&s++;return s},this.pokeForACK=function(s){for(;;)for(var n=0;n<t;n++)if(0==e[n].TIK)return e[n].TMS=Date.now(),e[n].MSG=s,e[n].TIK=parseInt(s.substring(1+s.indexOf("}")),10),pokeState.poked;return pokeState.fifoFull_},this.pikeForACK=function(s){for(var n=pikeState.notFound_,o=1+s.indexOf("}"),i=parseInt(s.substring(o),10),_=0;_<t;_++)0!=e[_].TIK&&console.log(`${_} ${e[_].TIK}\t${e[_].MSG}`),e[_].TIK==Math.abs(i)&&(n=pikeState.piked,this._latence=Date.now()-e[_].TMS,i>0&&(e[_].MSG="",e[_].TIK=0,e[_].TMS=0));return n}};function getRandomIntInclusive(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}const _RED="#ff0000",_GREY="#00ff00";var CFG={};function __text(t,e,s,n){var o=this;this.MIN=1e12,this.MAX=-1e12,this.App={},this._Elt=document.getElementById(e),this.Conf=n,console.log("§§§ NEW __text",n),this.MIN=n.min.value,this.MAX=n.max.value;var i=n.init;this._Elt.innerHTML="<input id='"+s+"' type='text' value='"+i.value+"' class='mv2_select "+t+"' STYLE='color: "+i.color+"; background-color: "+i.background_color+";' size='"+i.size+"' maxlength='"+i.maxlength+"'>",this._Elt=document.getElementById(s),this._setText=function(t){o._Elt.value=t,o._formText()},this._formText=function(){var t=parseInt(o._Elt.value,10);t=parseFloat(o._Elt.value,10),Number.isNaN(t)?(o._Elt.style.background=o.Conf.error.background_color,o._Elt.style.color=o.Conf.error.color):t<o.MIN?(o._Elt.style.background=o.Conf.min.background_color,o._Elt.style.color=o.Conf.min.color):o.MAX<t?(o._Elt.style.background=o.Conf.max.background_color,o._Elt.style.color=o.Conf.max.color):(o._Elt.style.background=o.Conf.init.background_color,o._Elt.style.color=o.Conf.init.color)},this.__textDefaultevents=function(t){o.App=t,o._Elt.onchange=function(){o._formText("***")}}}function __textarea(t,e,s,n){var o=this;this.MIN=1e12,this.MAX=-1e12,this.App={},this._Elt=document.getElementById(e),this.Conf=n,console.log("§§§ NEW __textarea",n),this.MIN=n.min.value,this.MAX=n.max.value;var i=n.init,_="<textarea id='"+s+"' cols='"+i.cols+"' rows='"+i.rows+"' class='mv2_select "+t+"' STYLE='color: "+i.color+"; background-color: "+i.background_color+"' maxlength='"+i.maxlength+"'>";this._Elt.innerHTML=_+i.value+"</textarea>",this._Elt=document.getElementById(s),this._setText=function(t){o._Elt.innerHTML=t},this._formText=function(){var t=parseInt(o._Elt.value,10);t=parseFloat(o._Elt.value,10),Number.isNaN(t)?(o._Elt.style.background=o.Conf.error.background_color,o._Elt.style.color=o.Conf.error.color):t<o.MIN?(o._Elt.style.background=o.Conf.min.background_color,o._Elt.style.color=o.Conf.min.color):o.MAX<t?(o._Elt.style.background=o.Conf.max.background_color,o._Elt.style.color=o.Conf.max.color):(o._Elt.style.background=o.Conf.init.background_color,o._Elt.style.color=o.Conf.init.color)},this.__textDefaultevents=function(t){o.App=t,o._Elt.onchange=function(){o._formText("***")}}}function __select(t,e,s,n,o,i){var _=this;this.App={},this._Elt=document.getElementById(e),this.cfgItems=clone(o),this.SELKEY="",this.keyIDX=new Array,this.idxKEY=new Array,this.sta={};var r=0;for(var l in o)this.keyIDX[r]=l,this.idxKEY[l]=r,isObject(o[l].kmd)&&isDefined(i)&&(this.cfgItems[l].kmd.OP=i),isObject(o[l].opt)&&o[l].opt.sel&&(this.SELKEY=l),isObject(o[l].help)&&(this.sta[o[l].help.sta]=l),console.log("----\x3e option   idx[",r,"]=",l,o[l]),r++;""!=this.SELKEY?console.log("====> Choosen    SELKEY=",this.SELKEY,o[this.SELKEY]):console.log("====> No default SELKEY."),this._Elt.innerHTML=filesToHtmlSelect(s,this.cfgItems,this.SELKEY,t),this._Elt=document.getElementById(s),this._cfgItemByIdx=function(t){return _.cfgItems[_.keyIDX[t]]},this._itemBySta=function(t){return _.cfgItems[_.sta[t]]},this._tagOption=function(t,e){var s;isDefined(e)?s=e:(s=_._Elt.selectedIndex,alert("_tagOption must specify an index IDX")),_._Elt[s].text=t.entry,_._Elt.style.background=t.background},this.selectOpt=function(t,e){console.log("selectOpt(",e,",",n,") [",t,"]:",_._cfgItemByIdx(t)),_._Elt.selectedIndex=t,_._tagOption(_._cfgItemByIdx(t).opt,t)},this.__selectDefaultevents=function(t){_.App=t,_._Elt.onchange=function(){_.selectOpt(_._Elt.value,!0)}},this.__selectNosendevents=function(t){_.App=t,_._Elt.onchange=function(){_.selectOpt(_._Elt.value,!1)}}}CFG.client={PILOT:{DIR:{MIN:-255,CLR:0,MAX:255},VIT:{MIN:-255,CLR:0,MAX:255}},TPIDDIR:{MIN:-255,MAX:255,KP:1,KI:0,KD:100,PROF:10},TPIDVIT:{MIN:-255,MAX:255,KP:1,KI:0,KD:100,PROF:10},CANVAS:{GAP:50,ANIMATE:!0,MOTORS:{MIN:-1023,CLR:0,MAX:1023},PILOT:{MIN:-255,CLR:0,MAX:255}},IOSERIAL:{HOST:"http://localhost:8888",SPEED:115200,TIMEOUT:100},LOG:{SCROLL:50},JOBGOAL:{NAME:"TOTO.kmd"},SOKTIMOUT:5e3,__field_dlvl:{DBG_0:{opt:{sel:0,show:1,entry:"0",background:"#aaaaaa"},kmd:{OP:"set_DLVL"}},DBG_1:{opt:{sel:0,show:1,entry:"1",background:"#aaaaff"},kmd:{OP:"set_DLVL"}},DBG_2:{opt:{sel:0,show:1,entry:"2",background:"#8888ff"},kmd:{OP:"set_DLVL"}},DBG_3:{opt:{sel:0,show:1,entry:"3",background:"#4444ff"},kmd:{OP:"set_DLVL"}},DBG_4:{opt:{sel:0,show:1,entry:"4",background:"#00aa00"},kmd:{OP:"set_DLVL"}},DBG_5:{opt:{sel:0,show:1,entry:"5",background:"#00ff00"},kmd:{OP:"set_DLVL"}},DBG_6:{opt:{sel:0,show:1,entry:"6",background:"#aaaa00"},kmd:{OP:"set_DLVL"}},DBG_7:{opt:{sel:0,show:1,entry:"7",background:"#ffff00"},kmd:{OP:"set_DLVL"}},DBG_8:{opt:{sel:0,show:1,entry:"8",background:"#ff8888"},kmd:{OP:"set_DLVL"}},DBG_9:{opt:{sel:0,show:1,entry:"9",background:_RED},kmd:{OP:"set_DLVL"}}},__field_timer:{LISTEN:{opt:{sel:1,show:1,entry:"   Never",background:"#aaaaaa"},kmd:{OP:"getTmsOut",codeTMS:-1}},SHOOT:{opt:{sel:0,show:1,entry:" 1 Shoot",background:"#888888"},kmd:{OP:"setTmsOut",codeTMS:0}},L_hour:{opt:{sel:0,show:1,entry:"1/(hour)",background:"#ffffff"},kmd:{OP:"setTmsOut",codeTMS:36e5}},L_5mn:{opt:{sel:0,show:1,entry:"1/(5 mn)",background:"#88ffff"},kmd:{OP:"setTmsOut",codeTMS:3e5}},L_1mn:{opt:{sel:0,show:1,entry:"1/(1 mn)",background:"#00ffff"},kmd:{OP:"setTmsOut",codeTMS:6e4}},L_10s:{opt:{sel:0,show:1,entry:"  0.1 Hz",background:"#00ff88"},kmd:{OP:"setTmsOut",codeTMS:1e4}},L_1s:{opt:{sel:0,show:1,entry:"    1 Hz",background:"#00ff00"},kmd:{OP:"setTmsOut",codeTMS:1e3}},L_500ms:{opt:{sel:0,show:1,entry:"    2 Hz",background:"#88ff00"},kmd:{OP:"setTmsOut",codeTMS:500}},L_200ms:{opt:{sel:0,show:1,entry:"    5 Hz",background:"#ffff00"},kmd:{OP:"setTmsOut",codeTMS:200}},L_100ms:{opt:{sel:0,show:1,entry:"   10 Hz",background:"#ff8800"},kmd:{OP:"setTmsOut",codeTMS:100}},L_50ms:{opt:{sel:0,show:1,entry:"   20 Hz",background:"#ff0000"},kmd:{OP:"setTmsOut",codeTMS:50}}},__field_txtarea:{init:{value:"86400",background_color:"#002200",color:"#ffffff",maxlength:360,cols:100,rows:15},max:{value:"-1",background_color:_GREY,color:"#000000",maxlength:60,size:62},error:{value:"???",background_color:"#000000",color:"#ffffff",maxlength:60,size:62},min:{value:_TMS_(),background_color:"#0000ff",color:"#ffffff",maxlength:60,size:62}},__field_txt:{max:{value:"86400",background_color:"#ff0000",color:"#ffffff",maxlength:60,size:62},init:{value:"-1",background_color:_GREY,color:"#000000",maxlength:60,size:62},error:{value:"???",background_color:"#000000",color:"#ffffff",maxlength:60,size:62},min:{value:_TMS_(),background_color:"#0000ff",color:"#ffffff",maxlength:60,size:62}},__Driver_exec:{Stop:{opt:{sel:1,show:1,entry:"STOP",background:"#ff0000"},timer:0,kmd:{OP:"Close",soks:["wsR"]}}},__Motors_exec:{Stop:{opt:{sel:1,show:1,entry:"STOP",background:"#ff0000"},timer:0,kmd:{OP:"Close",soks:["wsR"]}},PILOT:{opt:{sel:0,show:1,entry:"Pilotage",background:"#ABCDEF"},timer:6,kmd:{OP:"Pilot"}},TESTsquare:{opt:{sel:0,show:1,entry:"TSTsquare",background:"#aaaaaa"},timer:0,kmd:{OP:"TstSQ"}},LEARN:{opt:{sel:0,show:1,entry:"Circle",background:"#ffff00"},timer:7,kmd:{OP:"Open",soks:["wsR"]}}},__Datim_exec:{SynRover:{opt:{sel:1,show:1,entry:"TMS Rover",background:"#00ff00"},timer:0,kmd:{OP:"Syn",soks:["wsR"]}},SynBasis:{opt:{sel:0,show:1,entry:"TMS Basis",background:"#0000ff"},timer:0,kmd:{OP:"Syn",soks:["wsB"]}},SynAll:{opt:{sel:0,show:1,entry:"TMS All",background:"#ff0000"},timer:0,kmd:{OP:"Syn",soks:["wsR","wsB"]}}},__Jobgoal_exec:{Stop:{opt:{sel:1,show:1,entry:"STOP",background:"#ff0000"},timer:0,kmd:{OP:"Close",soks:["wsR"]}},Mis_1:{opt:{sel:0,show:1,entry:"Autotest",background:"#00ff00"},timer:6,kmd:{OP:"Open",soks:["wsR"]}},Mis_2:{opt:{sel:0,show:1,entry:"Circle",background:"#0088ff"},timer:6,kmd:{OP:"Open",soks:["wsR"]}},Mis_3:{opt:{sel:0,show:1,entry:"Autotest",background:"#ff8800"},timer:6,kmd:{OP:"Open",soks:["wsR"]}}},__Log_pilot:{LOG_0:{opt:{sel:1,show:1,entry:"-",background:"#aaaaaa"},kmd:{OP:"set_logLVL"}},LOG_S:{opt:{sel:0,show:1,entry:">",background:"#0000aa"},kmd:{OP:"set_logLVL"}},LOG_R:{opt:{sel:0,show:1,entry:"<",background:"#0000aa"},kmd:{OP:"set_logLVL"}},LOG_2:{opt:{sel:0,show:1,entry:"X",background:"#aaaa00"},kmd:{OP:"set_logLVL"}}},__Log_rover:{LOG_0:{opt:{sel:1,show:1,entry:"-",background:"#aaaaaa"},kmd:{OP:"set_logLVL"}},LOG_S:{opt:{sel:0,show:1,entry:">",background:"#0000aa"},kmd:{OP:"set_logLVL"}},LOG_R:{opt:{sel:0,show:1,entry:"<",background:"#0000aa"},kmd:{OP:"set_logLVL"}},LOG_2:{opt:{sel:0,show:1,entry:"X",background:"#aaaa00"},kmd:{OP:"set_logLVL"}}},__Leds_exec:{BLACK:{opt:{sel:1,show:1,entry:"- - -",background:"#000000"},kmd:{codeRYG:0}},G:{opt:{sel:0,show:1,entry:"- - G",background:"#00ff00"},kmd:{codeRYG:1}},Y:{opt:{sel:0,show:1,entry:"- Y -",background:"#ffff00"},kmd:{codeRYG:2}},YG:{opt:{sel:0,show:1,entry:"- Y G",background:"#ffff88"},kmd:{codeRYG:3}},R:{opt:{sel:0,show:1,entry:"R - -",background:"#ff0000"},kmd:{codeRYG:4}},RG:{opt:{sel:0,show:1,entry:"R - G",background:"#ffff00"},kmd:{codeRYG:5}},RY:{opt:{sel:0,show:1,entry:"R Y -",background:"#aaaa00"},kmd:{codeRYG:6}},RYG:{opt:{sel:0,show:1,entry:"R Y G",background:"#ffffff"},kmd:{codeRYG:7}}},__Socket_exec:{CONNECT:{opt:{sel:0,show:1,entry:"Connecter",background:"#00ff00"}},CLOSE:{opt:{sel:1,show:1,entry:"Fermer",background:"#ff0000"}},OPEN:{help:{sta:0,entry:"Connecté",background:"#ff0000"}},OPENING:{help:{sta:1,entry:"Connecte...",background:"#ffff00"}},CLOSING:{help:{sta:2,entry:"Deconnecte...",background:"#ffff00"}},CLOSED:{help:{sta:3,entry:"Fermé ou muet",background:"#888800"}},ONMESSAGE:{help:{sta:4,entry:"on Message",background:"#0000ff"}},NEW:{help:{sta:5,entry:"New",background:"#ffff00"}},ER_TIMEOUT:{help:{sta:14,entry:"Time OUT",background:"#ffff00"}},WHAT:{help:{sta:17,entry:"état inconnu",background:"#ff0000"}},ERRPARSE:{help:{sta:128,entry:"err Parser",background:"#ff0000"}},NOSERVER:{help:{sta:267,entry:"Pas de serveur",background:"#ff0000"}}}},SocketCLI=function(t,e,s,n){var o=this;this._name=t,this.cntWScnx=0,this.cntErrors=0,this.slot=n,this.PROTOCOL=s,this.sendCLI=function(t){try{o.WS.send(t)}catch(t){addMsg(0,"@@@ sendCLI to [",o.WS.url+" injoignable (pas de réseau?)","]"),addMsg(0,"DOMException("+t.code+"):"+t.name+" [",t.message,"]")}},this._status=function(t){return"id("+o.cntWScnx+"): "+o.cntErrors+' errors "'+t+'"'},this.Status=function(t){o.slot.affStatus(o._status(t))},this.stop=function(t){o.slot.stopSender(o._status(t))},this.addMsg=function(t,e,s){o.slot.addMsg(t,e,s)},this.CONNECT=function(){o.Status("Connect"),o.cntWScnx++;try{o.WS=new WebSocket(e,s),o.Status("Create"),o.WS.onopen=function(){o.Status("OPEN")},o.WS.onmessage=function(t){var e=ON_MESSAGE(o,(new Date).getTime(),t.data);if("?"==e.TYP)o.addMsg("<-rover","Parsing error ["+t.data+"]");else{var s=e.Rsignals;if(o.addMsg(s.SNS,e.RJsonchn,e.InfoRchn),"Q"==e.TYP){var n=e.Qsignals;o.addMsg(n.SNS,e.QJsonchn,e.InfoQchn)}}},o.WS.onclose=function(t){o.Status("Close ("+t.code+") "+t.reason),o.stop("CLOSE("+t.code+",'"+t.reason+"',"+t.wasClean+")"),setTimeout(function(){o.CONNECT()},100)},o.WS.onerror=function(t){o.stop("ERROR"),o.WS.close()}}catch(t){console.log(t)}}};var STATUX=Object.freeze({XOK:0,KO:1,ER_J_LOST:2,RUNNING:3,HALTED:4,ER_UNKNOWN:5,DEBUGON:6,SW_RESET:7,SW_UPLOAD:8,NEW:9,SW_NOSWITCHES:10,ER_RESETING:11,ER_PARSING:12,ER_MODULE:13,ER_TIMEOUT:14,ER_KMD:15,FS_ROPEN:16,ER_FOPEN:17,M__REMOTE:18,M__AUTO:19});function timerChange(t,e){console.log("[",e,"]:",t.TIM._cfgItemByIdx(e)),t.TIM._tagOption(t.TIM._cfgItemByIdx(e).opt,e),t.TIM.oldIdx=e;var s=parseInt(t.TIM._cfgItemByIdx(e).kmd.codeTMS,10);s>0?t._Timer.START_loop(s):0==s?(t._Timer.START_oneShoot(s),t.TIM.selectedIndex=0,t.TIM.selectOpt(0,!1)):t._Timer.STOP()}function set_defaultEvents(t,e){if(t.App=e,t.__OPchange(t.EXE.idxKEY[t.EXE.SELKEY]),isDefined(t.EXE.cfgItems[t.EXE.SELKEY].timer)){var s=t.EXE.cfgItems[t.EXE.SELKEY].timer;t.TIM.selectedIndex=s,t.TIM.selectOpt(s,!1),timerChange(t,s)}}function exeEvents(t,e){set_defaultEvents(t,e),t.EXE._Elt.onchange=function(){t.__OPchange(t.EXE._Elt.value)},t.TIM._Elt.onchange=function(){timerChange(t,t.TIM._Elt.value)}}function _runAPP(t,e,s,n,o,i,_,r,l,a){_TMS_();e.launchEvents(this),s.launchEvents(this),void 0!==n&&n.launchEvents(this),o.launchEvents(this),i.launchEvents(this),_.launchEvents(this),r.launchEvents(this),l.launchEvents(this),a.launchEvents(this)}function _TpidMmi(t){var e=this;e.PROF=t.PROF,this._MIN=t.MIN,this._MAX=t.MAX,this._KP=t.KP,this._KI=t.KI,this._KD=t.KD,this.ERRORS=[],this.TPS=[];for(var s=0;s<e.PROF;s++)this.ERRORS.push(0),this.TPS.push(0);function n(t,e){var s=t-1;return s<0?e-1:s}this.PTR=-1,this.CNT=0,this.feedback=function(t,s){!function(t,s){e.PTR=(e.PTR+1)%e.PROF,e.CNT++,e.CNT>e.PROF&&(e.CNT=e.PROF),e.ERRORS[e.PTR]=t,e.TPS[e.PTR]=s}(t,s);var o=e._KP*t+e._KI*function(){for(var t=0,s=e.PTR,o=1;o<e.CNT;o++){var i=n(s,e.PROF);t+=e.ERRORS[s]*(e.TPS[s]-e.TPS[i]),s=n(s,e.PROF)}return t}()+e._KD*function(){for(var t=0,s=e.PTR,o=1;o<e.CNT;o++){var i=n(s,e.PROF);t+=(e.ERRORS[s]-e.ERRORS[i])/(e.TPS[s]-e.TPS[i]),s=n(s,e.PROF)}return t}();return this._MAX<o&&(o=this._MAX),o<this._MIN&&(o=this._MIN),o}}function _PilotUmi(t,e,s){var n=this;function o(t,e){if(console.log("Position de la souris :  X="+t+"   Y="+e,joystickBounds),n._Listening){var s=t-n._CtrLbounds.left-n.Cd2_Width;s<0?s=0:n.CtrL_Width<s&&(s=n.CtrL_Width),n._Cursor.style.marginLeft=s+"px",n._VAL.DIR=n._MAX.DIR-(n._MAX.DIR-n._MIN.DIR)*(1-s/n.CtrL_Width);var o=e-n._CtrLbounds.top-n.Cd2_Height;o<0?o=0:n.CtrL_Height<o&&(o=n.CtrL_Height),n._Cursor.style.marginTop=o+"px",n._VAL.VIT=n._MIN.VIT+(n._MAX.VIT-n._MIN.VIT)*(1-o/n.CtrL_Height),console.log(n._VAL,s,o)}}this.CTRL=t,this.CURSOR=e,this._CtrL=document.getElementById(t),this._CtrLbounds=n._CtrL.getBoundingClientRect(),this._Cursor=document.getElementById(e),this.CtrL_Height=this._CtrL.offsetHeight-this._Cursor.offsetHeight,this.CtrL_Width=this._CtrL.offsetWidth-this._Cursor.offsetWidth,this.Cd2_Height=this._Cursor.offsetHeight/2,this.Cd2_Width=this._Cursor.offsetWidth/2,this._Listening=!1,this._MIN={DIR:s.DIR.MIN,VIT:s.VIT.MIN},this._VAL={DIR:s.DIR.CLR,VIT:s.VIT.CLR},this._MAX={DIR:s.DIR.MAX,VIT:s.VIT.MAX},this.placeCursor=function(){n._Cursor.style.marginTop=n.CtrL_Height*(1-(n._VAL.VIT-n._MIN.VIT)/(n._MAX.VIT-n._MIN.VIT))+"px",n._Cursor.style.marginLeft=n.CtrL_Width*((n._VAL.DIR-n._MIN.DIR)/(n._MAX.DIR-n._MIN.DIR))+"px"},this.placeCursor(),n._CtrL.onmousemove=function(t){t.preventDefault(),o(t.clientX,t.clientY)},n._CtrL.ontouchmove=function(t){t.preventDefault();var e=t.touches[0]||t.changedTouches[0];o(e.pageX,e.pageY)},n._Cursor.onmousedown=function(){console.log("SELF._Cursor.onmousedown : SELF._Listening ",n._Listening),n._Listening=!0,console.log("SELF._Cursor.onmousedown : SELF._Listening ",n._Listening)},n._Cursor.ontouchstart=function(){console.log("SELF._Cursor.ontouchstart : SELF._Listening ",n._Listening),n._Listening=!0,console.log("SELF._Cursor.ontouchstart : SELF._Listening ",n._Listening)},n._Cursor.onmouseup=function(){console.log("SELF._Cursor.onmouseup : SELF._Listening ",n._Listening),n._Listening=!1,console.log("SELF._Cursor.onmouseup : SELF._Listening ",n._Listening),n.stop()},n._Cursor.ontouchend=function(){console.log("SELF._Cursor.ontouchend : SELF._Listening ",n._Listening),n._Listening=!1,console.log("SELF._Cursor.ontouchend : SELF._Listening ",n._Listening),n.stop()},this.getVal=function(){return n._VAL},this.setFunctions=function(t,e,s,o){n._MIN=t,n._VAL=e,n._MAX=s,n._SET=o,n.placeCursor()},this.stop=function(){n._Listening=!1,n._VAL={DIR:s.DIR.CLR,VIT:s.VIT.CLR},n.placeCursor(),console.log(".stop",n._VAL)}}function _CanvasUmi(t,e,s,n,o,i){var _=this;function r(t){return _._CANVAS.height-_.Gheight*(t-_.Ymoins)/(_.Yplus-_.Ymoins)}this.Ymoins=e-n,this.Yplus=s+n,this._CANVAS=document.getElementById(t),this.Gwidth=_._CANVAS.width-70-5,this.Gheight=_._CANVAS.height-30-5,this._CANVAS?(this.Init=function(){if(this._CTX=this._CANVAS.getContext("2d"),this._CTX){this._CTX.fillStyle="#ffffff",this._CTX.fillRect(70,30,this.Gwidth,this.Gheight),this._CTX.strokeStyle="#880000";this._CTX.beginPath(),this._CTX.moveTo(68,28),this._CTX.lineTo(68,30+this.Gheight+2),this._CTX.lineTo(70+this.Gwidth+2,30+this.Gheight+2),this._CTX.lineTo(70+this.Gwidth+2,28),this._CTX.lineTo(68,28),this._CTX.stroke(),this._CTX.font="15px Arial",this._CTX.fillText(o,10,20);for(var t=0;t<i.length;t++)this._CTX.fillStyle=i[t].COLOR,this._CTX.fillText(i[t].LEGEND,100+50*t,20);this._CTX.fillStyle="#ffffff",this._CTX.font="10px Arial",this._CTX.fillText(SF_float(e,7,1),12,r(e)-2),this._CTX.fillText("+"+SF_float(s,7,1),12,r(s)+2),this._CTX.closePath(),this._CTX.arc(10,100,50,0,Math.PI),this._CTX.stroke()}else alert("Impossible de récupérer le contexte du canvas")},_.Init(),this.Circle=function(){this._CTX.fillStyle="#0000ff",this._CTX.arc(10,100,20,0,2*Math.PI),this._CTX.stroke(),this._CTX.closePath()},this.Text=function(t,e,s){this._CTX.font="30px Arial",this._CTX.fillText(t,e,s)},this.Point=function(t,e){this._CTX.beginPath(),this._CTX.moveTo(t,e),this._CTX.lineTo(t-1,e-1),this._CTX.stroke(),this._CTX.closePath()},this.addValue=function(t,e){this._CTX.strokeStyle=e,this.Point(70+_.Gwidth,r(t))},this.animate=function(){var t=_._CTX.getImageData(71,30,_.Gwidth,_.Gheight);_._CTX.putImageData(t,70,30),this._CTX.strokeStyle="#ffffff",this._CTX.beginPath(),this._CTX.moveTo(70+this.Gwidth,30),this._CTX.lineTo(70+this.Gwidth,30+this.Gheight),this._CTX.stroke(),this._CTX.closePath()},this.update=function(t){if(CFG.client.CANVAS.ANIMATE){this.addValue(s,"#888888"),this.addValue(0,"#88ff88"),this.addValue(e,"#888888");for(var n=0;n<t.length;n++)this.addValue(t[n],i[n].COLOR);this.animate()}}):alert("Impossible de récupérer le canvas")}function _Canvas2DUmi(t,e,s,n,o,i,_,r,l,a,c,T,h){var f=this;function d(t){return f.Gwidth-f.Gwidth*(n-t)/(n-e)}function u(t){return f.Gheight-f.Gheight*(t-o)/(_-o)}this._CANVAS=document.getElementById(t),this._CANVAS?(this.Gwidth=f._CANVAS.width-r-l,this.Gheight=f._CANVAS.height-a-c,this._CTX=this._CANVAS.getContext("2d"),this._CTX.translate(r,a),this.Init2D=function(){this._CTX.clearRect(0,0,this._CANVAS.width,this._CANVAS.height),this._CTX.fillStyle="#ffffff",this._CTX.fillRect(0,0,this.Gwidth,this.Gheight),this._CTX.beginPath(),this._CTX.strokeStyle="#880000";this._CTX.moveTo(-2,-2),this._CTX.lineTo(-2,+this.Gheight+2),this._CTX.lineTo(+this.Gwidth+2,+this.Gheight+2),this._CTX.lineTo(+this.Gwidth+2,-2),this._CTX.lineTo(-2,-2),this._CTX.stroke(),this._CTX.font="15px Arial",this._CTX.fillText(T,10,-6);for(var t=0;t<h.length;t++)this._CTX.fillStyle=h[t].COLOR,this._CTX.fillText(h[t].LEGEND,100+50*t,-6),h[t].oldCross=!1;this.Line(d(e),u(i),d(n),u(i),"#333333"),this.Line(d(s),u(o),d(s),u(_),"#ff00ff"),this._CTX.fillStyle="#000000",this._CTX.font="10px Arial",this._CTX.fillText(SF_float(e,7,1),d(e)-10,u(o)+15),this._CTX.fillText(SF_float(s,7,1),d(s)-20,u(o)+15),this._CTX.fillText(SF_float(n,7,1),d(n)-30,u(o)+15),this._CTX.rotate(-Math.PI/2),this._CTX.fillText(SF_float(o,7,1),-u(o)-10,-5),this._CTX.fillText(SF_float(i,7,1),-u(i)-20,-5),this._CTX.fillText(SF_float(_,7,1),-u(_)-30,-5),this._CTX.rotate(Math.PI/2),this._CTX.closePath(),this._CTX.beginPath(),this._CTX.arc(10,100,20,0,Math.PI/2),this._CTX.stroke(),this._CTX.closePath()},this.Circle=function(){this._CTX.fillStyle="#0000ff",this._CTX.arc(10,100,20,0,2*Math.PI),this._CTX.stroke(),this._CTX.closePath()},this.Text=function(t,e,s){this._CTX.font="30px Arial",this._CTX.fillText(t,e,s)},this.Point=function(t,e,s){this._CTX.beginPath(),this._CTX.strokeStyle=s,this._CTX.moveTo(t,e),this._CTX.lineTo(t-1,e-1),this._CTX.stroke(),this._CTX.closePath()},this.Xcross=function(t,e,s){this._CTX.beginPath(),this._CTX.strokeStyle=s,this._CTX.moveTo(t-5,e-5),this._CTX.lineTo(t+5,e+5),this._CTX.moveTo(t-5,e+5),this._CTX.lineTo(t+5,e-5),this._CTX.stroke(),this._CTX.closePath()},this.Line=function(t,e,s,n,o){this._CTX.beginPath(),this._CTX.strokeStyle=o,this._CTX.moveTo(t,e),this._CTX.lineTo(s,n),this._CTX.stroke(),this._CTX.closePath()},this.placeLine=function(t,e,s,n,o){var i=d(e),_=u(s),r=d(n),l=u(o);this.Line(i,_,r,l,h[t].COLOR)},this.moveMark=function(t,e,s){var n=Math.round(d(e)),o=Math.round(u(s));this.Point(n,o,h[t].COLOR),h[t].oldCross&&(f._CTX.putImageData(h[t].savedCross,h[t].prvCol+r-5,h[t].prvRow+a-5),f.Line(n,o,h[t].prvCol,h[t].prvRow,h[t].COLOR)),h[t].savedCross=f._CTX.getImageData(n+r-5,o+a-5,11,11),h[t].oldCross=!0,h[t].prvRow=o,h[t].prvCol=n,this.Xcross(n,o,h[t].COLOR)},f.Init2D()):alert("Impossible de récupérer le canvas")}Slot_socket=function(t,e,s,n,o,i,_,r,l){var a=this,c=l;this.DBG_loc=s,this.DBG_rov=n,this.EXE=o,this.TIM=i,this.TIO=_,this.sokROVER=r,this._Timer=new Timer,t[e]=this,this.Send=function(t,e){sendKMD(this.sokROVER,t,e,c)},this.__oneShot=function(){a.TIO._setText("+++++++")},this.affStatus=function(t){a.TIO._setText(t)},this.stopSender=function(t){a.TIO._setText(t)},this.addMsg=function(t,e,s){addMsg(0,t,e,s)},this.node__exeEvents=function(t){a.App=t,isDefined(this.sokROVER)&&this.sokROVER.CONNECT()},this.__exeEvents=function(t){isDefined(this.sokROVER)&&(this.sokROVER.slot=this),this.node__exeEvents(t),a.EXE._Elt.onchange=function(){var t=a.EXE._Elt.value;switch(console.log("[",t,"]:",a.EXE._cfgItemByIdx(t)),a.EXE._tagOption(a.EXE._cfgItemByIdx(t).opt,t),a.EXE.oldIdx=t,parseInt(t,10)){case 0:a.App.Init()||alert("Pas de connexion. Faire un reset du rover & recharger le pilote.");break;case 1:a.App.Shutdown(),a.EXE._tagOption(a.EXE.cfgItems.CLOSED.help);break;default:console.log("???????????"),SLOTROV.Send({set:parseInt(a.EXE._cfgItemByIdx(t).kmd.codeRYG,10)})}},a._Timer.CHANGE(a.__oneShot),a.TIM._Elt.onchange=function(){var t=a.TIM._Elt.value;console.log("[",t,"]:",a.TIM._cfgItemByIdx(t)),a.TIM._tagOption(a.TIM._cfgItemByIdx(t).opt,t);var e=parseInt(a.TIM._cfgItemByIdx(t).kmd.codeTMS,10),s={};s[a.TIM._cfgItemByIdx(t).kmd.OP]=e,SLOTROV.Send(s),e>=0&&a.__oneShot(),e>0?a._Timer.START_loop(e):a._Timer.STOP()}},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t),this.TIO.__textDefaultevents(t),this.__exeEvents(t)}},Slot_watchdog=function(t,e,s,n,o,i,_,r){t[e]=this;var l=this;this.DBG_loc=s,this.DBG_rov=n,this.TIO=i,this.TIM=o,this._Timer=new Timer,this.reply2query=function(t){return l.TIO._setText("WATCHDOG > ["+JSON.stringify(t)+"]"),t},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t)}},Slot_driver=function(t,e,s,n,o,i,_,r,l,a,c,T,h){t[e]=this;var f=this;this.DBG_loc=s,this.DBG_rov=n,this.TIO=_,this.TIM=i,this._Timer=new Timer,this.reply2query=function(t){return f.TIO._setText("DRIVER reply2query > ["+JSON.stringify(t)+"]\nsdlkjfwdfljk"),t},this.update2reply=function(e){var s="";if(void 0===e.MTS)return s="PROBLEME IMU ???",f.TIO._setText(s),void c.Init2D();s+="Ts="+SF_float(e.MTS/1e6,10,3)+" sec",s+="\n----------------ATTITUDE--------------",s+="\nPos("+SF_float(e.XC0,10,3)+SF_float(e.YC0,10,3)+SF_float(e.ZC0,10,3)+")m",s+="\nVel("+SF_float(e.SPX,10,3)+SF_float(e.SPY,10,3)+SF_float(e.SPZ,10,3)+")mm/s",s+="\nAcc("+SF_float(e.DAX,10,3)+SF_float(e.DAY,10,3)+SF_float(e.DAZ,10,3)+")mm/s²",s+="\nRPY("+SF_float(e.DNR,10,3)+SF_float(e.DEP,10,3)+SF_float(e.DDY,10,3)+")°",s+="\nGrv("+SF_float(e.DGX,10,3)+SF_float(e.DGY,10,3)+SF_float(e.DGZ,10,3)+")mg",s+="\n-----------------SENSORS--------------",s+="\nRad="+SF_float(e.DST,10,3)+" m, Temp=???",s+="\nAcc("+SF_float(e.Iax,10,3)+SF_float(e.Iay,10,3)+SF_float(e.Iaz,10,3)+")g",s+="\nGyr("+SF_float(e.Igx,10,3)+SF_float(e.Igy,10,3)+SF_float(e.Igz,10,3)+")°/s",s+="\nMag("+SF_float(e.Imx,10,3)+SF_float(e.Imy,10,3)+SF_float(e.Imz,10,3)+")mG",s+="\n-----------------MOTORS---------------",s+="\n  Left-Right("+SF_float(e[DEF_KF_LFT],10,3)+SF_float(e[DEF_KF_RGT],10,3)+")",s+="\n  Speed-Dir ("+SF_float(e.S,10,3)+SF_float(e.D,10,3)+")",f.TIO._setText(s);var n=e.XC0,o=e.YC0;e.ZC0;c.moveMark(1,n,o),c.moveMark(0,e.DAX,e.DAY),c.moveMark(2,e.DGX,e.DGY),t.TMS.update2reply(e)},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t)}},Slot_pilot=function(t,e,s,n,o,i,_,r,l,a,c,T){t[e]=this;var h=this,f="",d=0;this.DBG_loc=s,this.DBG_rov=n,this.EXE=o,this.TIM=i,this.TIO=_,this._Timer=new Timer,this.cntSQR=0;this.LIN=new Array(0,50,0,-50,0),this.ROT=new Array(50,0,-50,0,50),this.CNT=new Array(1,20,20,20,20),this.cycleIDX=0,this.update2reply=function(t){switch(t.OP){case"Open":if(f!=t.F)alert("Learning '"+f+"' error '"+t.F+"'?"),f="",d=0;else{h._Timer.CHANGE(h._OP_driving);var e=h.EXE._cfgItemByIdx(d).timer;h.TIM.selectedIndex=e,h.TIM.selectOpt(e,!1),timerChange(h,e)}break;case"Close":f="",h.TIO._setText(" < Learn STOPPED");break;default:h.TIO._setText("..."+JSON.stringify(t))}h.TIO._setText("Joystick(Run,Dir)=("+t.S+","+t.D+") <> (Left,Right)=("+t[DEF_KF_LFT]+","+t[DEF_KF_RGT]+")"),l.update([t.S,t.D]),a.update([Math.round(t[DEF_KF_LFT]),Math.round(t[DEF_KF_RGT])]),"Chk"!=t.OP&&"Inf"!=t.OP||(r._VAL={DIR:t.D,VIT:t.S},r.placeCursor())},this.OP_close_Learning=function(){""==f&&alert("No learning in progress. Force stopping !!!");var s=(new Date).getTime(),n={OP:"Close",TMS:s};h.SOKs.forEach(function(s){t[s].Send(e,n)}),h.TIO._setText("Ending learning TMS="+s)},this.OP_open_Learning=function(){(new Date).getTime();var s={OP:"Open",F:f};h.SOKs.forEach(function(n){t[n].Send(e,s)}),h.TIO._setText("Beginning learning on "+f)},this._OP_driving=function(){var t=r.getVal();console.log("joystick",t),c.Send("MOT",{OP:"Mot",S:Math.round(t.VIT),D:Math.round(t.DIR)}),h.TIO._setText("Joystick(Run,Dir)=("+Math.round(t.VIT)+","+Math.round(t.DIR)+") ")},this._OP_waveTest=function(){0==h.cntSQR&&(oldLIN=h.LIN[h.cycleIDX],oldROT=h.ROT[h.cycleIDX],h.cycleIDX=(h.cycleIDX+1)%h.LIN.length);var t=h.cycleIDX,e={S:h.LIN[t]+(oldLIN-h.LIN[t])*(h.CNT[t]-h.cntSQR)/h.CNT[t],D:h.ROT[t]+(oldROT-h.ROT[t])*(h.CNT[t]-h.cntSQR)/h.CNT[t]};r.placeCursor(),c.Send("MOT",Object.assign({OP:"Mot"},e)),h.TIO._setText("Square(Run,Dir)=("+e.S+","+e.D+") "),h.cntSQR=(h.cntSQR+1)%h.CNT[t]},this.reply2query=function(t){return t},this.__OPchange=function(t){console.log("[",t,"]:",h.EXE._cfgItemByIdx(t)),h.EXE._tagOption(h.EXE._cfgItemByIdx(t).opt,t);var e=h.EXE._cfgItemByIdx(t).kmd;switch(e.OP){case"TstSQ":h._Timer.CHANGE(h._OP_waveTest);break;case"Open":""!=f?(h.EXE._tagOption(h.EXE._cfgItemByIdx(d).opt,d),alert("Stop previous learning '"+f+"' please...")):(f=h.EXE._cfgItemByIdx(t).opt.entry,d=t,h.SOKs=e.soks,h._Timer.CHANGE(h.OP_open_Learning),h._Timer.START_oneShoot(10));break;case"Close":h._Timer.CHANGE(h.OP_close_Learning),h.SOKs=e.soks,h._Timer.START_oneShoot(10);break;case"Pilot":h._Timer.CHANGE(h._OP_driving);break;default:alert("Sorry, `"+e.OP+"` unkwnon !!")}},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t),this.TIO.__textDefaultevents(t),exeEvents(h,t)}},Slot_datim=function(t,e,s,n,o,i,_,r,l){t[e]=this;var a=this;this.DBG_loc=s,this.DBG_rov=n,this.EXE=o,this.TIM=i,this.TIO=_,this.SOKs,this._Timer=new Timer,this.update2reply=function(t){a.TIO._setText("DATIM < dTMS='"+t.DT+"' ms. MTS="+t.MTS)},this._OP_synchronize=function(){var e=(new Date).getTime(),s={OP:"Syn",TMS:e};a.TIO._setText("DATIM > TMS="+e),a.SOKs.forEach(function(e){t[e].Send("TMS",s)})},this.reply2query=function(t){var e=t;return e.DT=(new Date).getTime()-e.TMS,e},this.__OPchange=function(t){console.log("[",t,"]:",a.EXE._cfgItemByIdx(t)),a.EXE._tagOption(a.EXE._cfgItemByIdx(t).opt,t);var e=a.EXE._cfgItemByIdx(t).kmd;switch(e.OP){case"Syn":a._Timer.CHANGE(a._OP_synchronize),a.SOKs=e.soks;break;default:alert("Sorry, `"+e.OP+"` unkwnon !!")}},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t),this.TIO.__textDefaultevents(t),exeEvents(a,t),this._OP_synchronize()}},Slot_jobgoal=function(t,e,s,n,o,i,_,r,l,a,c,T){t[e]=this;var h=this,f="",d=0,u=-1;this.DBG_loc=s,this.DBG_rov=n,this.EXE=o,this.TIM=i,this.TIO=_,this.SOKs,this._Timer=new Timer,this.reply2query=function(t){h.TIO._setText("JOBGOAL > ["+JSON.stringify(t)+"]"),t["@"]-u==1&&u++;var e=t;return e.X=!0,e},this.update2reply=function(t){switch(t.OP){case"Open":f!=t.F?(alert("Jobgoal '"+f+"' error '"+t.F+"'?"),f="",d=0):(u=1,h._Timer.CHANGE(h._OP_scanRover),timerChange(h,d));break;case"Close":f="",h.TIO._setText("Jobgoal < STOPPED (Run="+t.X+").");break;default:h.TIO._setText(" < JOB run("+t.X+").")}},this.OP_close_Jobgoal=function(){""==f&&alert("No jobgoal in progress. Force stopping !!!");var s={OP:"Close"};h.SOKs.forEach(function(n){t[n].Send(e,s)}),h.TIO._setText("Jobgoal ending...")},this.OP_open_Jobgoal=function(){var s=(new Date).getTime(),n={OP:"Open",F:f};h.SOKs.forEach(function(s){t[s].Send(e,n)}),h.TIO._setText("Beginning jobgoal TMS="+s)},this._OP_scanRover=function(){var s={OP:"Ok?",TMS:(new Date).getTime()};h.SOKs.forEach(function(n){t[n].Send(e,s)})},this.__OPchange=function(t){console.log("[",t,"]:",h.EXE._cfgItemByIdx(t)),h.EXE._tagOption(h.EXE._cfgItemByIdx(t).opt,t);var e=h.EXE._cfgItemByIdx(t).kmd;switch(e.OP){case"Open":""!=f?(h.EXE._tagOption(h.EXE._cfgItemByIdx(d).opt,d),alert("Stop previous jobgoal '"+f+"' please...")):(f=h.EXE._cfgItemByIdx(t).opt.entry,d=t,h._Timer.CHANGE(h.OP_open_Jobgoal),h._Timer.START_oneShoot(10),h._Timer.CHANGE(h._OP_scanRover),h.SOKs=e.soks);break;case"Close":h._Timer.CHANGE(h.OP_close_Jobgoal),h.SOKs=e.soks,h._Timer.START_oneShoot(10);break;default:alert("Sorry, `"+e.OP+"` unkwnon !!")}},this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t),this.TIO.__textDefaultevents(t),exeEvents(h,t)}},Slot_filsys=function(t,e,s,n,o,i,_){this.TIM=n,this.DBG_rov=s,this.TIO=o,this._Timer=new Timer,t[e]=this,this.launchEvents=function(t){this.DBG_rov.__selectDefaultevents(t)}},Slot_leds=function(t,e,s,n,o,i,_,r,l){this.DBG_loc=s,this.DBG_rov=n,this.EXE=o,this.TIO=_,this._Timer=new Timer,t[e]=this,this.launchEvents=function(t){this.DBG_loc.__selectNosendevents(t),this.DBG_rov.__selectDefaultevents(t),this.TIO.__textDefaultevents(t)}},Switches=function(t){this._Timer=new Timer,MODULES[MID]=this},Power=function(t){this._Timer=new Timer,MODULES[MID]=this},Errors=function(t){this._Timer=new Timer,MODULES[MID]=this};var joystickBounds,_WSROV,_WSBAS,_MOTORS,Tick={n:-1},pseudo="=>",addMsg=function(){var t=0;return function(e,s,n,o){for(var i=0;i<e;i++)i+"   ";var _=document.getElementById("log").innerHTML;++t>10&&(_=_.substring(_.indexOf("</div>"))),document.getElementById("log").innerHTML=_+'<div class="line"><b>'+s+"</b>"+n+"<b>"+o+"</b></div>"}}(),LAYOUT={};function Start(){var t=new _Canvas2DUmi("MAPcanvas",-50,75,150,-100,100,200,20,2,25,20,"MAP",[{LEGEND:"Acc",COLOR:"#0000ff"},{LEGEND:"XY",COLOR:"#ff0000"},{LEGEND:"Gyr",COLOR:"#00ff00"}]),e=new _CanvasUmi("DRVcanvas",CFG.client.CANVAS.PILOT.MIN,CFG.client.CANVAS.PILOT.MAX,CFG.client.CANVAS.GAP,"Driver",[{LEGEND:"Speed",COLOR:"#ff0000"},{LEGEND:"Rotate",COLOR:"#0000ff"}]),s=new _CanvasUmi("MOTcanvas",CFG.client.CANVAS.MOTORS.MIN,CFG.client.CANVAS.MOTORS.MAX,CFG.client.CANVAS.GAP,"Motors",[{LEGEND:"Left",COLOR:"#ff0000"},{LEGEND:"Right",COLOR:"#0000ff"}]),n=new _PilotUmi("mv2_pilotJS","mv2_pilotCursor",CFG.client.PILOT);_WSROV=new Slot_socket(MODULES,"wsR",new __select("classDebug","divDbgLOC_WSROV","IDdbg_locSOCKET","wsR",CFG.client.__field_dlvl,"SOK_dbgLVL"),new __select("classDebug","divDbgROV_WSROV","IDdbg_rovSOCKET","wsR",CFG.client.__field_dlvl,"SOK_dbgLVL"),new __select("classExec","divExe_WSROV","IDexe_WSROV","wsR",CFG.client.__Socket_exec),new __select("classTimer","divTim_WSROV","IDtim_WSROV","wsR",CFG.client.__field_timer,"SOK_tmsOUT"),new __text("classT_i_o","divTio_WSROV","IDtio_WSROV",CFG.client.__field_txt),new SocketCLI("rover","ws://"+allCFG.roverURL+":"+allCFG.roverPORT+"/ws",DEF_QUERY_PILOT_TO_ROVER),allCFG.BamountTMS);var o=new Slot_watchdog(MODULES,"WAT",new __select("classDebug","divDbgLOC_WATCH","IDdbg_locGLO","WAT",CFG.client.__field_dlvl,"SELF_dbgLVL"),new __select("classDebug","divDbgROV_WATCH","IDdbg_rovGLO","WAT",CFG.client.__field_dlvl,"SELF_dbgLVL"),new __select("classTimer","divTim_WATCH","IDtim_SELF","WAT",CFG.client.__field_timer,"SELF_tmsOUT"),new __text("classT_i_o","divTio_WATCH","IDtio_SELF",CFG.client.__field_txt),_WSROV,_WSBAS),i=new Slot_filsys(MODULES,"F_S",new __select("classDebug","divDbgROV_FILSYS","IDdbg_rovFILSYS","F_S",CFG.client.__field_dlvl,"FIL_dbgLVL"),new __select("classTimer","divTim_FILSYS","IDtim_FILSYS","F_S",CFG.client.__field_timer,"FIL_tmsOUT"),new __text("classT_i_o","divTio_FILSYS","IDtio_SILSYS",CFG.client.__field_txt),_WSROV,_WSBAS),_=new Slot_datim(MODULES,"TMS",new __select("classDebug","divDbgLOC_DATIM","IDdbg_locDATIM","TMS",CFG.client.__field_dlvl),new __select("classDebug","divDbgROV_DATIM","IDdbg_rovDATIM","TMS",CFG.client.__field_dlvl),new __select("classExec","divExe_DATIM","IDexe_DATIM","TMS",CFG.client.__Datim_exec),new __select("classTimer","divTim_DATIM","IDtim_DATIM","TMS",CFG.client.__field_timer),new __text("classT_i_o","divTio_DATIM","IDtio_DATIM",CFG.client.__field_txt),_WSROV,_WSBAS);_MOTORS=new Slot_pilot(MODULES,"MOT",new __select("classDebug","divDbgLOC_MOTORS","IDdbg_locMOTORS","MOT",CFG.client.__field_dlvl),new __select("classDebug","divDbgROV_MOTORS","IDdbg_rovMOTORS","MOT",CFG.client.__field_dlvl),new __select("classExec","divExe_MOTORS","IDexe_MOTORS","MOT",CFG.client.__Motors_exec),new __select("classTimer","divTim_MOTORS","IDtim_MOTORS","MOT",CFG.client.__field_timer),new __text("classT_i_o","divTio_MOTORS","IDtio_MOTORS",CFG.client.__field_txt),n,e,s,_WSROV,_WSBAS);var r=new Slot_driver(MODULES,"DRV",new __select("classDebug","divDbgLOC_DRIVER","IDdbg_locDRIVER","DRV",CFG.client.__field_dlvl),new __select("classDebug","divDbgROV_DRIVER","IDdbg_rovDRIVER","DRV",CFG.client.__field_dlvl),new __select("classExec","divExe_DRIVER","IDexe_DRIVER","DRV",CFG.client.__Driver_exec),new __select("classTimer","divTim_DRIVER","IDtim_DRIVER","DRV",CFG.client.__field_timer),new __textarea("classTA_i_o","ATTITUDE","IDtio_DRIVER",CFG.client.__field_txtarea),n,e,s,t,_WSROV,_WSBAS),l=new Slot_jobgoal(MODULES,"JOB",new __select("classDebug","divDbgLOC_JOBGOAL","IDdbg_locJOBGOAL","JOB",CFG.client.__field_dlvl),new __select("classDebug","divDbgROV_JOBGOAL","IDdbg_rovJOBGOAL","JOB",CFG.client.__field_dlvl),new __select("classExec","divExe_JOBGOAL","IDexe_JOBGOAL","JOB",CFG.client.__Jobgoal_exec),new __select("classTimer","divTim_JOBGOAL","IDtim_JOBGOAL","JOB",CFG.client.__field_timer),new __text("classT_i_o","divTio_JOBGOAL","IDtio_JOBGOAL",CFG.client.__field_txt),n,e,s,_WSROV,_WSBAS),a=new Slot_leds(MODULES,"LED",new __select("classDebug","divDbgLOC_LEDS","IDdbg_locLEDS","LED",CFG.client.__field_dlvl),new __select("classDebug","divDbgROV_LEDS","IDdbg_rovLEDS","LED",CFG.client.__field_dlvl),new __select("classExec","divExe_LEDS","IDexe_LEDS","LED",CFG.client.__Leds_exec),new __select("classTimer","divTim_LEDS","IDtim_LEDS","LED",CFG.client.__field_timer),new __text("classT_i_o","divTio_LEDS","IDtio_LEDS",CFG.client.__field_txt),_WSROV,_WSBAS),c=document.getElementById("mv2_pilotJS");joystickBounds=c.getBoundingClientRect(),console.log(joystickBounds);new _TpidMmi(CFG.client.TPIDDIR),new _TpidMmi(CFG.client.TPIDVIT);LAYOUT={CENTER:{MOTORS:document.getElementById("MOTORS"),MAP:document.getElementById("MAP"),ATTITUDE:document.getElementById("ATTITUDE")},HEAD:{},FOOT:{},LEFT:{},RIGHT:{}};for(var T=document.getElementById("horizontalMenu").getElementsByClassName("toyBtn"),h=0;h<T.length;h++)T[h].addEventListener("click",function(){var t=document.getElementsByClassName("Hactive");t[0].className=t[0].className.replace(" Hactive",""),this.className+=" Hactive"});this.APP=new _runAPP(MODULES,o,_WSROV,_WSBAS,i,_,a,_MOTORS,l,r)}var envoiManualKommand=function(t){var e=document.getElementById("ModKmd").value,s=e.split("$");return""!=e&&MODULES[t].Send(s[0],JSON.parse("{"+s[1]+"}")),!1};function showViewsDefault(t){for(var e of Object.keys(LAYOUT[t])){Object.assign(LAYOUT[t][e]).className=e+" "+e+"_default"}}function showView(t,e){showViewsDefault(t),Object.assign(LAYOUT[t][e]).className=e+" "+t+"_offset"}function PILOT(){var t=document.getElementById("btn_Pilot");"bigBtn"===t.className?(t.className+=" Vactive",_MOTORS.TIM.selectOpt(8),_MOTORS.EXE.selectOpt(1),_MOTORS.__OPchange(1),timerChange(_MOTORS,8)):(t.className="bigBtn",_MOTORS.TIM.selectOpt(0),_MOTORS.EXE.selectOpt(0),_MOTORS.__OPchange(0),timerChange(_MOTORS,0))}function RELOAD(){location.reload()}function RESET(){_WSROV.sokROVER.sendCLI("@"),setTimeout(RELOAD,3e4)}